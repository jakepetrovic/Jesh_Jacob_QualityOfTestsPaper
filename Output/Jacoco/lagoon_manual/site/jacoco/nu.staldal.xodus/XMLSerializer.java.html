<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>XMLSerializer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Ant Example</a> &gt; <a href="index.source.html" class="el_package">nu.staldal.xodus</a> &gt; <span class="el_source">XMLSerializer.java</span></div><h1>XMLSerializer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, Mikael Stï¿½ldal
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without 
 * modification, are permitted provided that the following conditions 
 * are met:
 * 
 * 1. Redistributions of source code must retain the above copyright 
 * notice, this list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright 
 * notice, this list of conditions and the following disclaimer in the 
 * documentation and/or other materials provided with the distribution.
 * 
 * 3. Neither the name of the author nor the names of its contributors 
 * may be used to endorse or promote products derived from this software 
 * without specific prior written permission. 
 * 
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 
 * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT 
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR 
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, 
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, 
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR 
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY 
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 * 
 * Note: This is known as &quot;the modified BSD license&quot;. It's an approved 
 * Open Source and Free Software license, see 
 * http://www.opensource.org/licenses/ 
 * and
 * http://www.gnu.org/philosophy/license-list.html
 */

package nu.staldal.xodus;

import java.util.*;
import java.io.*;
import java.net.URL;
import java.net.URLConnection;

import org.xml.sax.*;
import org.xml.sax.ext.LexicalHandler;
import org.xml.sax.ext.DeclHandler;
import org.xml.sax.helpers.NamespaceSupport;
import org.xml.sax.helpers.AttributesImpl;

import javax.xml.transform.Result;
import javax.xml.transform.stream.StreamResult;


public class XMLSerializer extends Serializer
{
<span class="fc" id="L60">    private final String XHTML_NS = &quot;http://www.w3.org/1999/xhtml&quot;;</span>

<span class="fc" id="L62">    private boolean disableOutputEscaping = false;</span>
<span class="fc" id="L63">    private boolean emptyElement = false;</span>
<span class="fc" id="L64">    private int nestedCDATA = 0;</span>
<span class="fc" id="L65">    private boolean inDTD = false;</span>
<span class="fc" id="L66">    private boolean dtdContent = false;</span>
<span class="fc" id="L67">    private boolean addDTD = true;</span>
    
    private NamespaceSupport nsSup;
    private boolean contextPushed;
    private int prefixNum;
    
<span class="fc" id="L73">    private int elementDepth = 0;</span>
<span class="fc" id="L74">    private boolean wasEndTag = false;</span>
<span class="fc" id="L75">    private boolean wasStartTag = false;</span>
<span class="fc" id="L76">    private int inFormattedElement = 0;</span>
    
    private final Set emptyElements;
    private final Set formattedElements;
    
    
    XMLSerializer(StreamResult result, OutputConfig outputConfig)
        throws IllegalArgumentException, IOException, 
            UnsupportedEncodingException
    {
<span class="fc" id="L86">        super(result, outputConfig);</span>
        
<span class="fc" id="L88">        nsSup = new NamespaceSupport();</span>
<span class="fc" id="L89">        contextPushed = false;</span>
<span class="fc" id="L90">        prefixNum = 0;</span>
        
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (outputConfig.isXhtml)</span>
        {
<span class="fc" id="L94">            emptyElements = new HashSet(13);</span>
<span class="fc" id="L95">            emptyElements.add(&quot;area&quot;);</span>
<span class="fc" id="L96">            emptyElements.add(&quot;base&quot;);</span>
<span class="fc" id="L97">            emptyElements.add(&quot;br&quot;);</span>
<span class="fc" id="L98">            emptyElements.add(&quot;col&quot;);</span>
<span class="fc" id="L99">            emptyElements.add(&quot;hr&quot;);</span>
<span class="fc" id="L100">            emptyElements.add(&quot;img&quot;);</span>
<span class="fc" id="L101">            emptyElements.add(&quot;input&quot;);</span>
<span class="fc" id="L102">            emptyElements.add(&quot;link&quot;);</span>
<span class="fc" id="L103">            emptyElements.add(&quot;meta&quot;);</span>
<span class="fc" id="L104">            emptyElements.add(&quot;basefont&quot;);</span>
<span class="fc" id="L105">            emptyElements.add(&quot;frame&quot;);</span>
<span class="fc" id="L106">            emptyElements.add(&quot;isindex&quot;);</span>
<span class="fc" id="L107">            emptyElements.add(&quot;param&quot;);</span>

<span class="fc" id="L109">            formattedElements = new HashSet(4);</span>
<span class="fc" id="L110">            formattedElements.add(&quot;pre&quot;);</span>
<span class="fc" id="L111">            formattedElements.add(&quot;script&quot;);</span>
<span class="fc" id="L112">            formattedElements.add(&quot;style&quot;);</span>
<span class="fc" id="L113">            formattedElements.add(&quot;textarea&quot;);</span>
        }
        else
        {
<span class="fc" id="L117">            emptyElements = null;</span>
<span class="fc" id="L118">            formattedElements = null;</span>
        }                
<span class="fc" id="L120">    }</span>

	private String genPrefix()
	{
<span class="fc" id="L124">		return &quot;ns&quot; + (++prefixNum);</span>
	}
    
    
    // ContentHandler implementation
    
    /**
     * Does nothing.
     */
    public void setDocumentLocator(Locator locator)
    {
        // nothing to do    
<span class="nc" id="L136">    }</span>

    
    public void startDocument()
	    throws SAXException
    {
<span class="fc" id="L142">        wasEndTag = false;</span>
<span class="fc" id="L143">        wasStartTag = false;</span>
        
        try {
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            if (outputConfig.omit_xml_declaration &lt; 1)</span>
            {
<span class="pc bpc" id="L148" title="6 of 12 branches missed.">                if (outputConfig.isXhtml</span>
                        &amp;&amp; outputConfig.omit_xml_declaration == 0
                        &amp;&amp; !outputConfig.standalone
                        &amp;&amp; outputConfig.version.equals(&quot;1.0&quot;)
                        &amp;&amp; (outputConfig.encoding.equalsIgnoreCase(&quot;UTF-8&quot;)
                                || outputConfig.encoding.equalsIgnoreCase(&quot;UTF-16&quot;)))
                {
                    // omit XML declaration if possible in XHTML    
                }
                else
                {
<span class="fc" id="L159">                    out.write(&quot;&lt;?xml version=\&quot;&quot;);</span>
<span class="fc" id="L160">                    out.write(outputConfig.version);</span>
<span class="fc" id="L161">                    out.write(&quot;\&quot; encoding=\&quot;&quot;);</span>
<span class="fc" id="L162">                    out.write(outputConfig.encoding);</span>
<span class="fc" id="L163">                    out.write('\&quot;');</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                    if (outputConfig.standalone)</span>
                    {
<span class="nc" id="L166">                        out.write(&quot; standalone=\&quot;yes\&quot;&quot;);</span>
                    }
<span class="fc" id="L168">                    out.write(&quot;?&gt;&quot;);</span>
<span class="fc" id="L169">                    newline();</span>
                }
            }            
        }        
<span class="nc" id="L173">        catch (IOException e)</span>
        {
<span class="nc" id="L175">            throw new SAXException(e);    </span>
<span class="fc" id="L176">        }                        </span>
<span class="fc" id="L177">    }</span>

    
    public void startPrefixMapping(String prefix, String uri)
	    throws SAXException
    {
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (!contextPushed)</span>
        {
<span class="nc" id="L185">            nsSup.pushContext();</span>
<span class="nc" id="L186">            contextPushed = true;</span>
        }

<span class="nc" id="L189">        nsSup.declarePrefix(prefix, uri);</span>
<span class="nc" id="L190">    }</span>


    public void endPrefixMapping(String prefix)
	    throws SAXException
    {
        // nothing to do
<span class="nc" id="L197">    }</span>


    private void writeAttribute(String attQName, String attValue)
        throws IOException
    {
<span class="fc" id="L203">        out.write(' ');</span>
<span class="fc" id="L204">        out.write(attQName);</span>
<span class="fc" id="L205">        out.write(&quot;=\&quot;&quot;);</span>
        
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (disableOutputEscaping)</span>
        {
<span class="nc" id="L209">            out.write(attValue);</span>
        }
        else
        {
<span class="fc" id="L213">            out.enableEscaping();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">            for (int i = 0; i&lt;attValue.length(); i++)</span>
            {
<span class="fc" id="L216">                char c = attValue.charAt(i);</span>
<span class="pc bpc" id="L217" title="3 of 5 branches missed.">                switch (c)</span>
                {
                case '&lt;':
<span class="nc" id="L220">                    out.write(&quot;&amp;lt;&quot;);</span>
<span class="nc" id="L221">                    break;</span>

                case '&gt;':
<span class="nc" id="L224">                    out.write(&quot;&amp;gt;&quot;);</span>
<span class="nc" id="L225">                    break;</span>
                
                case '&amp;':
<span class="nc" id="L228">                    out.write(&quot;&amp;amp;&quot;);</span>
<span class="nc" id="L229">                    break;</span>

                case '\&quot;':
<span class="fc" id="L232">                    out.write(&quot;&amp;quot;&quot;);</span>
<span class="fc" id="L233">                    break;</span>
                
                default:
<span class="fc" id="L236">                    out.write(c);</span>
                }
            }
<span class="fc" id="L239">            out.disableEscaping();</span>
        }
        
<span class="fc" id="L242">        out.write('\&quot;');                        </span>
<span class="fc" id="L243">    }</span>
    
    
    public void startElement(String namespaceURI, String localName,
			      String qName, Attributes atts)
	    throws SAXException
    {
<span class="fc" id="L250">        fixTag();</span>

<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        if (!contextPushed)</span>
        {
<span class="fc" id="L254">            nsSup.pushContext();</span>
        }
<span class="fc" id="L256">        contextPushed = false;</span>

<span class="pc bpc" id="L258" title="2 of 4 branches missed.">        if (qName == null || qName.length() == 0)</span>
        {
<span class="fc" id="L260">            String prefix = nsSup.getPrefix(namespaceURI);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">            if (prefix == null)</span>
            {
<span class="fc" id="L263">				String nullURI = nsSup.getURI(&quot;&quot;);</span>
<span class="pc bpc" id="L264" title="4 of 8 branches missed.">				if (((namespaceURI == null) || (namespaceURI.length() == 0))</span>
					&amp;&amp; ((nullURI == null) || (nullURI.length() == 1)))
				{
<span class="fc" id="L267">					prefix = &quot;&quot;;</span>
				}
				else
				{
<span class="fc" id="L271">					String defaultURI = nsSup.getURI(&quot;&quot;);</span>
<span class="fc bfc" id="L272" title="All 4 branches covered.">	                if ((defaultURI != null) &amp;&amp; defaultURI.equals(namespaceURI))</span>
                    {
<span class="fc" id="L274">	                    prefix = &quot;&quot;; // default namespace</span>
                    }
	                else
					{
<span class="pc bpc" id="L278" title="1 of 6 branches missed.">	                    if (outputConfig.isXhtml &amp;&amp; defaultURI == null </span>
                                &amp;&amp; namespaceURI.equals(XHTML_NS))
                        {
<span class="fc" id="L281">                            prefix = &quot;&quot;;    </span>
                        }
                        else
                        {
<span class="fc" id="L285">                            prefix = genPrefix();</span>
                        }
<span class="fc" id="L287">						nsSup.declarePrefix(prefix, namespaceURI);</span>
					}
			 	}
            }
<span class="fc bfc" id="L291" title="All 2 branches covered.">            qName = ((prefix.length() == 0) ? &quot;&quot; : (prefix + ':')) + localName;            </span>
<span class="fc" id="L292">        }</span>
<span class="nc bnc" id="L293" title="All 4 branches missed.">        else if (localName == null || localName.length() == 0)</span>
        {
<span class="nc" id="L295">            String[] parts = new String[3];</span>
<span class="nc" id="L296">            nsSup.processName(qName, parts, false);</span>
<span class="nc" id="L297">            localName = parts[1];</span>
        }
        
        try {
<span class="fc bfc" id="L301" title="All 2 branches covered.">            if (addDTD)</span>
            {
<span class="fc bfc" id="L303" title="All 2 branches covered.">                if (outputConfig.doctype_system != null)</span>
                {
<span class="fc" id="L305">                    out.write(&quot;&lt;!DOCTYPE &quot;);</span>
<span class="fc" id="L306">                    out.write(qName);</span>
<span class="fc" id="L307">                    out.write(' ');</span>
<span class="fc" id="L308">                    writeExternalId(outputConfig.doctype_public,</span>
                        outputConfig.doctype_system);
<span class="fc" id="L310">                    out.write('&gt;');</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">                    if (outputConfig.indent)</span>
                    {                
<span class="nc" id="L313">                        newline();</span>
                    }
                }  
<span class="fc" id="L316">                addDTD = false;</span>
            }
            
<span class="fc bfc" id="L319" title="All 8 branches covered.">            if (outputConfig.indent &amp;&amp; (wasStartTag || wasEndTag) &amp;&amp; inFormattedElement == 0)</span>
            {
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">                if (elementDepth &gt; 0)</span>
                {
<span class="fc" id="L323">                    newline();</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">                    for (int i = 0; i&lt;elementDepth*2; i++)</span>
                    {
<span class="fc" id="L326">                        out.write(' ');</span>
                    }
                }
            }
<span class="fc" id="L330">            out.write('&lt;');</span>
<span class="fc" id="L331">            out.write(qName);</span>

<span class="fc" id="L333">            boolean hasXmlns = false;</span>
<span class="fc" id="L334">            Set xmlns = new HashSet();</span>
            
<span class="fc bfc" id="L336" title="All 2 branches covered.">            for (int j = 0; j&lt;atts.getLength(); j++)</span>
            {
<span class="fc" id="L338">                String attQName = atts.getQName(j);</span>
<span class="pc bpc" id="L339" title="1 of 4 branches missed.">                if (attQName == null || attQName.length() == 0)</span>
                {
<span class="fc" id="L341">                    String attUri = atts.getURI(j);</span>
<span class="fc" id="L342">                    String attLocalName = atts.getLocalName(j);</span>
<span class="fc bfc" id="L343" title="All 2 branches covered.">                    if (attUri.length() == 0)</span>
                    {
<span class="fc" id="L345">                        attQName = attLocalName;</span>
                    }
                    else
                    {
<span class="fc" id="L349">                        String prefix = nsSup.getPrefix(attUri);</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">                        if (prefix == null)</span>
                        {
<span class="fc" id="L352">                            prefix = genPrefix();</span>
<span class="fc" id="L353">                            nsSup.declarePrefix(prefix, attUri);</span>
                        }
<span class="fc" id="L355">                        attQName = prefix + ':' + attLocalName;</span>
                    }
                }
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">                if (attQName.equals(&quot;xmlns&quot;))</span>
                {
<span class="nc" id="L360">                    hasXmlns = true;    </span>
                }
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">                else if (attQName.startsWith(&quot;xmlns:&quot;))</span>
                {
<span class="nc" id="L364">                    xmlns.add(attQName.substring(6));</span>
                }
<span class="fc" id="L366">                writeAttribute(attQName, atts.getValue(j));                </span>
            }
            
<span class="fc" id="L369">			for (Enumeration e = nsSup.getDeclaredPrefixes(); </span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">                 e.hasMoreElements(); )</span>
			{
<span class="fc" id="L372">				String prefix = (String)e.nextElement();</span>
<span class="fc" id="L373">				String uri = nsSup.getURI(prefix);</span>
<span class="fc bfc" id="L374" title="All 2 branches covered.">				if (prefix.length() == 0)</span>
				{
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">					if (!hasXmlns)</span>
                    {
<span class="fc" id="L378">                        writeAttribute(&quot;xmlns&quot;, uri);</span>
<span class="fc" id="L379">                        hasXmlns = true;</span>
                    }
				}
				else
				{
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">					if (!xmlns.contains(prefix))</span>
                    {
<span class="fc" id="L386">                        writeAttribute(&quot;xmlns:&quot;+prefix, uri);</span>
<span class="fc" id="L387">                        xmlns.add(prefix);</span>
                    }
				}
<span class="fc" id="L390">			}            </span>
        }
<span class="nc" id="L392">        catch (IOException e)</span>
        {
<span class="nc" id="L394">            throw new SAXException(e);    </span>
<span class="fc" id="L395">        }            </span>

<span class="fc bfc" id="L397" title="All 2 branches covered.">        if (outputConfig.isXhtml)</span>
        {
<span class="fc bfc" id="L399" title="All 2 branches covered.">            if (formattedElements.contains(localName))</span>
<span class="fc" id="L400">                inFormattedElement++;</span>
        }        
        
<span class="fc" id="L403">        elementDepth++; </span>
<span class="fc" id="L404">        emptyElement = true;</span>
<span class="fc" id="L405">        wasStartTag = true;</span>

<span class="pc bpc" id="L407" title="1 of 4 branches missed.">        if (outputConfig.isXhtml &amp;&amp; localName.equals(&quot;head&quot;))</span>
        {
<span class="nc" id="L409">            AttributesImpl metaAtts = new AttributesImpl();</span>
<span class="nc" id="L410">            metaAtts.addAttribute(&quot;&quot;, &quot;http-equiv&quot;, &quot;&quot;, &quot;CDATA&quot;, </span>
                &quot;Content-Type&quot;);
<span class="nc" id="L412">            metaAtts.addAttribute(&quot;&quot;, &quot;content&quot;, &quot;&quot;, &quot;CDATA&quot;, </span>
                outputConfig.media_type+&quot;; charset=&quot;+outputConfig.encoding);
<span class="nc" id="L414">            startElement(XHTML_NS, &quot;meta&quot;, &quot;&quot;, metaAtts);</span>
<span class="nc" id="L415">            endElement(XHTML_NS, &quot;meta&quot;, &quot;&quot;);            </span>
        }        
<span class="fc" id="L417">    }</span>


    private void fixTag()
	    throws SAXException
    {
        try {
<span class="fc bfc" id="L424" title="All 2 branches covered.">            if (emptyElement)</span>
            {
<span class="fc" id="L426">                out.write('&gt;');    </span>
<span class="fc" id="L427">                emptyElement = false;</span>
            }
        }
<span class="nc" id="L430">        catch (IOException e)</span>
        {
<span class="nc" id="L432">            throw new SAXException(e);    </span>
<span class="fc" id="L433">        }        </span>
<span class="fc" id="L434">    }</span>
    

    public void endElement(String namespaceURI, String localName, String qName)
	    throws SAXException
    {        
<span class="fc" id="L440">        elementDepth--;</span>
                
<span class="pc bpc" id="L442" title="2 of 4 branches missed.">        if (qName == null || qName.length() == 0)</span>
        {
<span class="fc" id="L444">            String prefix = nsSup.getPrefix(namespaceURI);</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">            if (prefix == null)</span>
            {
<span class="fc" id="L447">				String nullURI = nsSup.getURI(&quot;&quot;);</span>
<span class="pc bpc" id="L448" title="4 of 8 branches missed.">				if (((namespaceURI == null) || (namespaceURI.length() == 0))</span>
					&amp;&amp; ((nullURI == null) || (nullURI.length() == 1)))
				{
<span class="fc" id="L451">					prefix = &quot;&quot;;</span>
				}
				else
				{
<span class="fc" id="L455">					String defaultURI = nsSup.getURI(&quot;&quot;);</span>
<span class="pc bpc" id="L456" title="2 of 4 branches missed.">	                if ((defaultURI != null) &amp;&amp; defaultURI.equals(namespaceURI))</span>
<span class="fc" id="L457">	                    prefix = &quot;&quot;; // default namespace</span>
	                else
					{
<span class="nc" id="L460">                        throw new SAXException(&quot;No namespace prefix declared for &quot;</span>
                            + namespaceURI);
					}
			 	}
            }
<span class="fc bfc" id="L465" title="All 2 branches covered.">            qName = ((prefix.length() == 0) ? &quot;&quot; : (prefix + ':')) + localName;            </span>
<span class="fc" id="L466">        }</span>
<span class="nc bnc" id="L467" title="All 4 branches missed.">        else if (localName == null || localName.length() == 0)</span>
        {
<span class="nc" id="L469">            String[] parts = new String[3];</span>
<span class="nc" id="L470">            nsSup.processName(qName, parts, false);</span>
<span class="nc" id="L471">            localName = parts[1];</span>
        }
                
        try {
<span class="fc bfc" id="L475" title="All 6 branches covered.">            if (emptyElement </span>
                    &amp;&amp; (!outputConfig.isXhtml 
                        || emptyElements.contains(localName))) 
            {
<span class="fc bfc" id="L479" title="All 2 branches covered.">                if (outputConfig.isXhtml)</span>
                {
<span class="fc" id="L481">                    out.write(&quot; /&gt;&quot;);</span>
                }
                else
                {
<span class="fc" id="L485">                    out.write(&quot;/&gt;&quot;);</span>
                }
<span class="fc" id="L487">                emptyElement = false;</span>
            }
            else
            {
<span class="fc bfc" id="L491" title="All 2 branches covered.">                if (emptyElement)</span>
                {
<span class="fc" id="L493">                    out.write('&gt;');</span>
                }
                
<span class="fc bfc" id="L496" title="All 6 branches covered.">                if (outputConfig.indent &amp;&amp; wasEndTag &amp;&amp; inFormattedElement == 0)</span>
                {
<span class="fc" id="L498">                    newline();</span>
<span class="fc bfc" id="L499" title="All 2 branches covered.">                    for (int i = 0; i&lt;elementDepth*2; i++)</span>
                    {
<span class="fc" id="L501">                        out.write(' ');</span>
                    }
                }
<span class="fc" id="L504">                out.write(&quot;&lt;/&quot;);</span>
<span class="fc" id="L505">                out.write(qName);</span>
<span class="fc" id="L506">                out.write('&gt;');</span>
            }
<span class="fc" id="L508">            emptyElement = false;</span>
        }
<span class="nc" id="L510">        catch (IOException e)</span>
        {
<span class="nc" id="L512">            throw new SAXException(e);    </span>
<span class="fc" id="L513">        }</span>

<span class="fc bfc" id="L515" title="All 2 branches covered.">        if (outputConfig.isXhtml)</span>
        {
<span class="fc bfc" id="L517" title="All 2 branches covered.">            if (formattedElements.contains(localName))</span>
<span class="fc" id="L518">                inFormattedElement--;</span>
        }
        
<span class="fc" id="L521">        wasEndTag = true;</span>
        
<span class="fc" id="L523">        nsSup.popContext();        </span>
<span class="fc" id="L524">    }</span>


    public void characters(char ch[], int start, int length)
	    throws SAXException
    {
<span class="fc" id="L530">        wasEndTag = false;</span>
<span class="fc" id="L531">        wasStartTag = false;</span>

<span class="fc" id="L533">        fixTag();</span>
        
        try {
<span class="fc bfc" id="L536" title="All 4 branches covered.">            if (disableOutputEscaping || nestedCDATA &gt; 0)</span>
            {
<span class="fc" id="L538">                out.write(ch, start, length);</span>
            }
            else
            {
<span class="fc" id="L542">                out.enableEscaping();</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">                for (int i = start; i&lt;start+length; i++)</span>
                {
<span class="fc" id="L545">                    char c = ch[i];</span>
<span class="fc bfc" id="L546" title="All 4 branches covered.">                    switch (c)</span>
                    {
                    case '&lt;':
<span class="fc" id="L549">                        out.write(&quot;&amp;lt;&quot;);</span>
<span class="fc" id="L550">                        break;</span>

                    case '&gt;':
<span class="fc" id="L553">                        out.write(&quot;&amp;gt;&quot;);</span>
<span class="fc" id="L554">                        break;</span>
                    
                    case '&amp;':
<span class="fc" id="L557">                        out.write(&quot;&amp;amp;&quot;);</span>
<span class="fc" id="L558">                        break;</span>
                    
                    default:
<span class="fc" id="L561">                        out.write(c);</span>
                    }
                }
<span class="fc" id="L564">                out.disableEscaping();</span>
            }
        }
<span class="nc" id="L567">        catch (IOException e)</span>
        {
<span class="nc" id="L569">            throw new SAXException(e);    </span>
<span class="fc" id="L570">        }</span>
<span class="fc" id="L571">    }</span>


    public void ignorableWhitespace(char ch[], int start, int length)
	    throws SAXException
    {
<span class="nc" id="L577">        characters(ch, start, length);</span>
<span class="nc" id="L578">    }</span>


    /**
     * Will honor 
     * {@link javax.xml.transform.Result#PI_DISABLE_OUTPUT_ESCAPING} 
     * and 
     * {@link javax.xml.transform.Result#PI_ENABLE_OUTPUT_ESCAPING}. 
     */
    public void processingInstruction(String target, String data)
	    throws SAXException
    {
<span class="pc bpc" id="L590" title="2 of 4 branches missed.">        if (target == null || target.length() == 0)</span>
<span class="nc" id="L591">            throw new NullPointerException(&quot;No PI target&quot;);</span>
        
<span class="fc bfc" id="L593" title="All 2 branches covered.">        if (target.equals(Result.PI_DISABLE_OUTPUT_ESCAPING))</span>
        {
<span class="fc" id="L595">            disableOutputEscaping = true;    </span>
        }
<span class="fc bfc" id="L597" title="All 2 branches covered.">        else if (target.equals(Result.PI_ENABLE_OUTPUT_ESCAPING)) </span>
        {
<span class="fc" id="L599">            disableOutputEscaping = false;    </span>
        }
        else
        {
<span class="fc" id="L603">            fixDTD();        </span>
<span class="fc" id="L604">            fixTag();</span>
                    
            try {
<span class="fc" id="L607">                out.write(&quot;&lt;?&quot;);</span>
<span class="fc" id="L608">                out.write(target);</span>
<span class="pc bpc" id="L609" title="1 of 4 branches missed.">                if (data != null &amp;&amp; data.length() &gt; 0)</span>
                {
<span class="fc" id="L611">                    out.write(' ');</span>
<span class="fc" id="L612">                    out.write(data);</span>
                }
<span class="fc" id="L614">                out.write(&quot;?&gt;&quot;);</span>
            }
<span class="nc" id="L616">            catch (IOException e)</span>
            {
<span class="nc" id="L618">                throw new SAXException(e);    </span>
<span class="fc" id="L619">            }            </span>
        }
<span class="fc" id="L621">    }</span>

    
    public void skippedEntity(String name)
	    throws SAXException
    {
<span class="fc" id="L627">        wasEndTag = false;</span>
<span class="fc" id="L628">        wasStartTag = false;</span>

<span class="fc" id="L630">        fixTag();</span>
        
        try {
<span class="fc bfc" id="L633" title="All 2 branches covered.">            if (name.charAt(0) == '%')</span>
            {
<span class="fc" id="L635">                out.write(name);</span>
<span class="fc" id="L636">                out.write(';');</span>
            }
<span class="fc bfc" id="L638" title="All 2 branches covered.">            else if (name.equals(&quot;[dtd]&quot;))</span>
            {
                // nothing to do    
            }
            else
            {
<span class="fc" id="L644">                out.write('&amp;');</span>
<span class="fc" id="L645">                out.write(name);</span>
<span class="fc" id="L646">                out.write(';');</span>
            }
        }
<span class="nc" id="L649">        catch (IOException e)</span>
        {
<span class="nc" id="L651">            throw new SAXException(e);    </span>
<span class="fc" id="L652">        }            </span>
<span class="fc" id="L653">    }</span>
    

    public void endDocument()
	    throws SAXException
    {
<span class="fc" id="L659">        fixTag();</span>
        
        try {
<span class="fc bfc" id="L662" title="All 2 branches covered.">            if (outputConfig.indent)</span>
            {                
<span class="fc" id="L664">                newline();</span>
            }
<span class="fc" id="L666">            finishOutput();</span>
        }
<span class="nc" id="L668">        catch (IOException e)</span>
        {
<span class="nc" id="L670">            throw new SAXException(e);    </span>
<span class="fc" id="L671">        }</span>
<span class="fc" id="L672">    }</span>
    
    
    // LexicalHandler implementation

    private void writeExternalId(String publicId, String systemId)
        throws IOException
    {
<span class="fc bfc" id="L680" title="All 2 branches covered.">        if (publicId != null)</span>
        {
<span class="fc" id="L682">            out.write(&quot;PUBLIC \&quot;&quot;);</span>
<span class="fc" id="L683">            out.write(publicId);</span>
<span class="fc" id="L684">            out.write(&quot;\&quot; \&quot;&quot;);</span>
<span class="fc" id="L685">            out.write(systemId);</span>
<span class="fc" id="L686">            out.write('\&quot;');                    </span>
        }
        else
        {
<span class="fc" id="L690">            out.write(&quot;SYSTEM \&quot;&quot;);</span>
<span class="fc" id="L691">            out.write(systemId);</span>
<span class="fc" id="L692">            out.write('\&quot;');                    </span>
        }        
<span class="fc" id="L694">    }</span>
    
    
    public void startDTD(String name, String publicId, String systemId)
	    throws SAXException
    {
        try {
<span class="fc" id="L701">            out.write(&quot;&lt;!DOCTYPE &quot;);</span>
<span class="fc" id="L702">            out.write(name);</span>
            
<span class="pc bpc" id="L704" title="1 of 2 branches missed.">            if (outputConfig.doctype_system != null)</span>
<span class="fc" id="L705">                systemId = outputConfig.doctype_system;</span>
<span class="pc bpc" id="L706" title="1 of 2 branches missed.">            if (outputConfig.doctype_public != null)</span>
<span class="nc" id="L707">                publicId = outputConfig.doctype_public;</span>
            
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">            if (systemId != null)</span>
            {
<span class="fc" id="L711">                out.write(' ');</span>
<span class="fc" id="L712">                writeExternalId(publicId, systemId);</span>
            }
<span class="fc" id="L714">            inDTD = true;</span>
<span class="fc" id="L715">            addDTD = false;</span>
        }
<span class="nc" id="L717">        catch (IOException e)</span>
        {
<span class="nc" id="L719">            throw new SAXException(e);    </span>
<span class="fc" id="L720">        }        </span>
<span class="fc" id="L721">    }</span>


    private void fixDTD()
        throws SAXException
    {
<span class="fc bfc" id="L727" title="All 2 branches covered.">        if (inDTD)</span>
        {
<span class="fc bfc" id="L729" title="All 2 branches covered.">            if (!dtdContent)</span>
            {
                try {                    
<span class="fc" id="L732">                    out.write(&quot; [&quot;);</span>
<span class="fc" id="L733">                    dtdContent = true;</span>
                }
<span class="nc" id="L735">                catch (IOException e)</span>
                {
<span class="nc" id="L737">                    throw new SAXException(e);    </span>
<span class="fc" id="L738">                }                            </span>
            }
        }
<span class="fc" id="L741">    }</span>


    public void endDTD()
	    throws SAXException
    {
<span class="fc" id="L747">        inDTD = false;</span>
        
        try {
<span class="pc bpc" id="L750" title="1 of 2 branches missed.">            if (dtdContent)</span>
            {
<span class="fc" id="L752">                out.write(']');                </span>
            }
<span class="fc" id="L754">            out.write('&gt;');</span>
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">            if (outputConfig.indent)</span>
            {                
<span class="nc" id="L757">                newline();</span>
            }
        }
<span class="nc" id="L760">        catch (IOException e)</span>
        {
<span class="nc" id="L762">            throw new SAXException(e);    </span>
<span class="fc" id="L763">        }        </span>
<span class="fc" id="L764">    }</span>
    
    
    /**
     * Does nothing.
     */
    public void startEntity(String name)
	    throws SAXException
    {
        // nothing to do
<span class="nc" id="L774">    }</span>


    /**
     * Does nothing.
     */
    public void endEntity(String name)
	    throws SAXException
    {
        // nothing to do
<span class="nc" id="L784">    }</span>


    public void startCDATA()
	    throws SAXException
    {
<span class="fc" id="L790">        fixTag();</span>
        
        try {
<span class="pc bpc" id="L793" title="1 of 2 branches missed.">            if (nestedCDATA == 0)</span>
            {
<span class="fc" id="L795">                out.write(&quot;&lt;![CDATA[&quot;);</span>
            }
<span class="fc" id="L797">            nestedCDATA++;</span>
        }
<span class="nc" id="L799">        catch (IOException e)</span>
        {
<span class="nc" id="L801">            throw new SAXException(e);    </span>
<span class="fc" id="L802">        }        </span>
<span class="fc" id="L803">    }</span>


    public void endCDATA()
	    throws SAXException
    {        
        try {
<span class="pc bpc" id="L810" title="1 of 2 branches missed.">            if (nestedCDATA &gt; 0)</span>
            {
<span class="fc" id="L812">                nestedCDATA--;</span>
<span class="pc bpc" id="L813" title="1 of 2 branches missed.">                if (nestedCDATA == 0)</span>
                {
<span class="fc" id="L815">                    out.write(&quot;]]&gt;&quot;);</span>
                }
            }
            else
            {
<span class="nc" id="L820">                throw new SAXException(&quot;endCDATA without startCDATA&quot;);    </span>
            }
        }
<span class="nc" id="L823">        catch (IOException e)</span>
        {
<span class="nc" id="L825">            throw new SAXException(e);    </span>
<span class="fc" id="L826">        }</span>
<span class="fc" id="L827">    }</span>


    public void comment(char ch[], int start, int length)
	    throws SAXException
    {
<span class="fc" id="L833">        fixDTD();        </span>
<span class="fc" id="L834">        fixTag();</span>
        
        try {
<span class="fc" id="L837">            out.write(&quot;&lt;!-- &quot;);</span>
<span class="fc" id="L838">            out.write(ch, start, length);            </span>
<span class="fc" id="L839">            out.write(&quot; --&gt;&quot;);</span>
        }
<span class="nc" id="L841">        catch (IOException e)</span>
        {
<span class="nc" id="L843">            throw new SAXException(e);    </span>
<span class="fc" id="L844">        }        </span>
<span class="fc" id="L845">    }</span>
    

    // DTDHandler implementation

    public void notationDecl(String name, String publicId, String systemId)
	    throws SAXException
    {
<span class="fc" id="L853">        fixDTD();</span>

        try {
<span class="fc" id="L856">            out.write(&quot;&lt;!NOTATION &quot;);</span>
<span class="fc" id="L857">            out.write(name);</span>
<span class="fc" id="L858">            out.write(' ');</span>
<span class="fc bfc" id="L859" title="All 4 branches covered.">            if (publicId != null &amp;&amp; systemId != null)</span>
            {
<span class="fc" id="L861">                out.write(&quot;PUBLIC \&quot;&quot;);</span>
<span class="fc" id="L862">                out.write(publicId);</span>
<span class="fc" id="L863">                out.write(&quot;\&quot; \&quot;&quot;);</span>
<span class="fc" id="L864">                out.write(systemId);</span>
<span class="fc" id="L865">                out.write('\&quot;');                    </span>
            }
<span class="fc bfc" id="L867" title="All 2 branches covered.">            else if (systemId != null)</span>
            {
<span class="fc" id="L869">                out.write(&quot;SYSTEM \&quot;&quot;);</span>
<span class="fc" id="L870">                out.write(systemId);</span>
<span class="fc" id="L871">                out.write('\&quot;');                    </span>
            }
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">            else if (publicId != null)</span>
            {
<span class="fc" id="L875">                out.write(&quot;PUBLIC \&quot;&quot;);</span>
<span class="fc" id="L876">                out.write(publicId);</span>
<span class="fc" id="L877">                out.write('\&quot;');                    </span>
            }
            else
            {
<span class="nc" id="L881">                throw new SAXException(&quot;notationDecl without publicId or systemId&quot;);    </span>
            }
<span class="fc" id="L883">            out.write('&gt;');</span>
        }
<span class="nc" id="L885">        catch (IOException e)</span>
        {
<span class="nc" id="L887">            throw new SAXException(e);    </span>
<span class="fc" id="L888">        }                </span>
<span class="fc" id="L889">    }</span>
    
    
    public void unparsedEntityDecl(String name, String publicId,
					               String systemId, String notationName)
        throws SAXException
    {        
<span class="fc" id="L896">        fixDTD();</span>

        try {
<span class="fc" id="L899">            out.write(&quot;&lt;!ENTITY &quot;);</span>
<span class="fc" id="L900">            out.write(name);</span>
<span class="fc" id="L901">            out.write(' ');</span>
<span class="fc" id="L902">            writeExternalId(publicId, systemId);</span>
<span class="fc" id="L903">            out.write(&quot; NDATA &quot;);</span>
<span class="fc" id="L904">            out.write(notationName);</span>
<span class="fc" id="L905">            out.write('&gt;');</span>
        }
<span class="nc" id="L907">        catch (IOException e)</span>
        {
<span class="nc" id="L909">            throw new SAXException(e);    </span>
<span class="fc" id="L910">        }                                </span>
<span class="fc" id="L911">    }</span>
    

    // DeclHandler implementation
      
    public void elementDecl(String name, String model)
	    throws SAXException
    {        
<span class="fc" id="L919">        fixDTD();</span>

        try {
<span class="fc" id="L922">            out.write(&quot;&lt;!ELEMENT &quot;);</span>
<span class="fc" id="L923">            out.write(name);</span>
<span class="fc" id="L924">            out.write(' ');</span>
<span class="fc" id="L925">            out.write(model);</span>
<span class="fc" id="L926">            out.write('&gt;');</span>
        }
<span class="nc" id="L928">        catch (IOException e)</span>
        {
<span class="nc" id="L930">            throw new SAXException(e);    </span>
<span class="fc" id="L931">        }                                </span>
<span class="fc" id="L932">    }</span>


    public void attributeDecl(String eName, String aName,
					          String type, String mode, String value)
        throws SAXException
    {        
<span class="fc" id="L939">        fixDTD();</span>

        try {
<span class="fc" id="L942">            out.write(&quot;&lt;!ATTLIST &quot;);</span>
<span class="fc" id="L943">            out.write(eName);</span>
<span class="fc" id="L944">            out.write(' ');</span>
<span class="fc" id="L945">            out.write(aName);</span>
<span class="fc" id="L946">            out.write(' ');</span>
<span class="fc" id="L947">            out.write(type);</span>
<span class="fc bfc" id="L948" title="All 2 branches covered.">            if (mode != null)</span>
            {
<span class="fc" id="L950">                out.write(' ');</span>
<span class="fc" id="L951">                out.write(mode);</span>
            }
<span class="fc bfc" id="L953" title="All 2 branches covered.">            if (value != null)</span>
            {
<span class="fc" id="L955">                out.write(&quot; \&quot;&quot;);</span>
<span class="fc" id="L956">                out.write(value);</span>
<span class="fc" id="L957">                out.write('\&quot;');</span>
            }                            
<span class="fc" id="L959">            out.write('&gt;');</span>
        }
<span class="nc" id="L961">        catch (IOException e)</span>
        {
<span class="nc" id="L963">            throw new SAXException(e);    </span>
<span class="fc" id="L964">        }                                        </span>
<span class="fc" id="L965">    }</span>


    public void internalEntityDecl(String name, String value)
	    throws SAXException
    {        
<span class="fc" id="L971">        fixDTD();        </span>

<span class="pc bpc" id="L973" title="1 of 2 branches missed.">        if (name.charAt(0) == '%')</span>
        {
<span class="nc" id="L975">            name = &quot;% &quot; + name.substring(1);    </span>
        }
        
        try {
<span class="fc" id="L979">            out.write(&quot;&lt;!ENTITY &quot;);</span>
<span class="fc" id="L980">            out.write(name);</span>
<span class="fc" id="L981">            out.write(&quot; \&quot;&quot;);</span>
<span class="fc" id="L982">            out.write(value);</span>
<span class="fc" id="L983">            out.write(&quot;\&quot;&gt;&quot;);</span>
        }
<span class="nc" id="L985">        catch (IOException e)</span>
        {
<span class="nc" id="L987">            throw new SAXException(e);    </span>
<span class="fc" id="L988">        }                                </span>
<span class="fc" id="L989">    }</span>


    public void externalEntityDecl(String name, String publicId,
					               String systemId)
        throws SAXException
    {        
<span class="fc" id="L996">        fixDTD();        </span>

<span class="pc bpc" id="L998" title="1 of 2 branches missed.">        if (name.charAt(0) == '%')</span>
        {
<span class="nc" id="L1000">            name = &quot;% &quot; + name.substring(1);    </span>
        }
        
        try {
<span class="fc" id="L1004">            out.write(&quot;&lt;!ENTITY &quot;);</span>
<span class="fc" id="L1005">            out.write(name);</span>
<span class="fc" id="L1006">            out.write(' ');</span>
<span class="fc" id="L1007">            writeExternalId(publicId, systemId);</span>
<span class="fc" id="L1008">            out.write('&gt;');</span>
        }
<span class="nc" id="L1010">        catch (IOException e)</span>
        {
<span class="nc" id="L1012">            throw new SAXException(e);    </span>
<span class="fc" id="L1013">        }                                </span>
<span class="fc" id="L1014">    }</span>
    
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201405220205</span></div></body></html>