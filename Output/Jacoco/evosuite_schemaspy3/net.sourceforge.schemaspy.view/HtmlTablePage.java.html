<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HtmlTablePage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Ant Example</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.schemaspy.view</a> &gt; <span class="el_source">HtmlTablePage.java</span></div><h1>HtmlTablePage.java</h1><pre class="source lang-java linenums">/*
 * This file is a part of the SchemaSpy project (http://schemaspy.sourceforge.net).
 * Copyright (C) 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 John Currier
 *
 * SchemaSpy is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * SchemaSpy is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 */
package net.sourceforge.schemaspy.view;

import java.io.File;
import java.io.IOException;
import java.text.NumberFormat;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import net.sourceforge.schemaspy.Config;
import net.sourceforge.schemaspy.model.Database;
import net.sourceforge.schemaspy.model.ForeignKeyConstraint;
import net.sourceforge.schemaspy.model.Table;
import net.sourceforge.schemaspy.model.TableColumn;
import net.sourceforge.schemaspy.model.TableIndex;
import net.sourceforge.schemaspy.model.View;
import net.sourceforge.schemaspy.util.CaseInsensitiveMap;
import net.sourceforge.schemaspy.util.Dot;
import net.sourceforge.schemaspy.util.HtmlEncoder;
import net.sourceforge.schemaspy.util.LineWriter;

/**
 * The page that contains the details of a specific table or view
 *
 * @author John Currier
 */
public class HtmlTablePage extends HtmlFormatter {
<span class="fc" id="L48">    private static final HtmlTablePage instance = new HtmlTablePage();</span>
<span class="fc" id="L49">    private int columnCounter = 0;</span>

<span class="fc" id="L51">    private final Map&lt;String, String&gt; defaultValueAliases = new HashMap&lt;String, String&gt;();</span>
    {
<span class="fc" id="L53">        defaultValueAliases.put(&quot;CURRENT TIMESTAMP&quot;, &quot;now&quot;); // DB2</span>
<span class="fc" id="L54">        defaultValueAliases.put(&quot;CURRENT TIME&quot;, &quot;now&quot;);      // DB2</span>
<span class="fc" id="L55">        defaultValueAliases.put(&quot;CURRENT DATE&quot;, &quot;now&quot;);      // DB2</span>
<span class="fc" id="L56">        defaultValueAliases.put(&quot;SYSDATE&quot;, &quot;now&quot;);           // Oracle</span>
<span class="fc" id="L57">        defaultValueAliases.put(&quot;CURRENT_DATE&quot;, &quot;now&quot;);      // Oracle</span>
    }

    /**
     * Singleton: Don't allow instantiation
     */
<span class="fc" id="L63">    private HtmlTablePage() {</span>
<span class="fc" id="L64">    }</span>

    /**
     * Singleton accessor
     *
     * @return the singleton instance
     */
    public static HtmlTablePage getInstance() {
<span class="fc" id="L72">        return instance;</span>
    }

    public WriteStats write(Database db, Table table, File outputDir, WriteStats stats, LineWriter out) throws IOException {
<span class="nc" id="L76">        File diagramsDir = new File(outputDir, &quot;diagrams&quot;);</span>
<span class="nc" id="L77">        boolean hasImplied = generateDots(table, diagramsDir, stats);</span>

<span class="nc" id="L79">        writeHeader(db, table, null, out);</span>
<span class="nc" id="L80">        out.writeln(&quot;&lt;table width='100%' border='0'&gt;&quot;);</span>
<span class="nc" id="L81">        out.writeln(&quot;&lt;tr valign='top'&gt;&lt;td class='container' align='left' valign='top'&gt;&quot;);</span>
<span class="nc" id="L82">        writeHeader(table, hasImplied, out);</span>
<span class="nc" id="L83">        out.writeln(&quot;&lt;/td&gt;&lt;td class='container' rowspan='2' align='right' valign='top'&gt;&quot;);</span>
<span class="nc" id="L84">        writeLegend(true, out);</span>
<span class="nc" id="L85">        out.writeln(&quot;&lt;/td&gt;&lt;tr valign='top'&gt;&lt;td class='container' align='left' valign='top'&gt;&quot;);</span>
<span class="nc" id="L86">        writeMainTable(table, out);</span>
<span class="nc" id="L87">        writeNumRows(db, table, out);</span>
<span class="nc" id="L88">        out.writeln(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L89">        writeCheckConstraints(table, out);</span>
<span class="nc" id="L90">        writeIndexes(table, out);</span>
<span class="nc" id="L91">        writeView(table, db, out);</span>
<span class="nc" id="L92">        writeDiagram(table, stats, diagramsDir, out);</span>
<span class="nc" id="L93">        writeFooter(out);</span>

<span class="nc" id="L95">        return stats;</span>
    }

    private void writeHeader(Table table, boolean hasImplied, LineWriter html) throws IOException {
<span class="nc" id="L99">        html.writeln(&quot;&lt;form name='options' action=''&gt;&quot;);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (hasImplied) {</span>
<span class="nc" id="L101">            html.write(&quot; &lt;label for='implied'&gt;&lt;input type=checkbox id='implied'&quot;);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (table.isOrphan(false))</span>
<span class="nc" id="L103">                html.write(&quot; checked&quot;);</span>
<span class="nc" id="L104">            html.writeln(&quot;&gt;Implied relationships&lt;/label&gt;&quot;);</span>
        }

        // initially show comments if any of the columns contain comments
<span class="nc" id="L108">        boolean showCommentsInitially = false;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        for (TableColumn column : table.getColumns()) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (column.getComments() != null) {</span>
<span class="nc" id="L111">                showCommentsInitially = true;</span>
<span class="nc" id="L112">                break;</span>
            }
<span class="nc" id="L114">        }</span>

<span class="nc" id="L116">        html.writeln(&quot; &lt;label for='showRelatedCols'&gt;&lt;input type=checkbox id='showRelatedCols'&gt;Related columns&lt;/label&gt;&quot;);</span>
<span class="nc" id="L117">        html.writeln(&quot; &lt;label for='showConstNames'&gt;&lt;input type=checkbox id='showConstNames'&gt;Constraints&lt;/label&gt;&quot;);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        html.writeln(&quot; &lt;label for='showComments'&gt;&lt;input type=checkbox &quot; + (showCommentsInitially  ? &quot;checked &quot; : &quot;&quot;) + &quot;id='showComments'&gt;Comments&lt;/label&gt;&quot;);</span>
<span class="nc" id="L119">        html.writeln(&quot; &lt;label for='showLegend'&gt;&lt;input type=checkbox checked id='showLegend'&gt;Legend&lt;/label&gt;&quot;);</span>
<span class="nc" id="L120">        html.writeln(&quot;&lt;/form&gt;&quot;);</span>
<span class="nc" id="L121">    }</span>

    public void writeMainTable(Table table, LineWriter out) throws IOException {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        HtmlColumnsPage.getInstance().writeMainTableHeader(table.getId() != null, null, out);</span>

<span class="nc" id="L126">        out.writeln(&quot;&lt;tbody valign='top'&gt;&quot;);</span>
<span class="nc" id="L127">        Set&lt;TableColumn&gt; primaries = new HashSet&lt;TableColumn&gt;(table.getPrimaryColumns());</span>
<span class="nc" id="L128">        Set&lt;TableColumn&gt; indexedColumns = new HashSet&lt;TableColumn&gt;();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        for (TableIndex index : table.getIndexes()) {</span>
<span class="nc" id="L130">            indexedColumns.addAll(index.getColumns());</span>
<span class="nc" id="L131">        }</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        boolean showIds = table.getId() != null;</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        for (TableColumn column : table.getColumns()) {</span>
<span class="nc" id="L135">            writeColumn(column, null, primaries, indexedColumns, false, showIds, out);</span>
<span class="nc" id="L136">        }</span>
<span class="nc" id="L137">        out.writeln(&quot;&lt;/tbody&gt;&quot;);</span>
<span class="nc" id="L138">        out.writeln(&quot;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L139">    }</span>

    public void writeColumn(TableColumn column, String tableName, Set&lt;TableColumn&gt; primaries, Set&lt;TableColumn&gt; indexedColumns, boolean slim, boolean showIds, LineWriter out) throws IOException {
<span class="pc bfc" id="L142" title="All 2 branches covered.">        boolean even = columnCounter++ % 2 == 0;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (even)</span>
<span class="nc" id="L144">            out.writeln(&quot;&lt;tr class='even'&gt;&quot;);</span>
        else
<span class="nc" id="L146">            out.writeln(&quot;&lt;tr class='odd'&gt;&quot;);</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (showIds) {</span>
<span class="nc" id="L149">            out.write(&quot; &lt;td class='detail' align='right'&gt;&quot;);</span>
<span class="nc" id="L150">            out.write(String.valueOf(column.getId()));</span>
<span class="nc" id="L151">            out.writeln(&quot;&lt;/td&gt;&quot;);</span>
        }
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (tableName != null) {</span>
<span class="nc" id="L154">            out.write(&quot; &lt;td class='detail'&gt;&lt;a href='tables/&quot;);</span>
<span class="nc" id="L155">            out.write(urlEncode(tableName));</span>
<span class="nc" id="L156">            out.write(&quot;.html'&gt;&quot;);</span>
<span class="nc" id="L157">            out.write(tableName);</span>
<span class="nc" id="L158">            out.writeln(&quot;&lt;/a&gt;&lt;/td&gt;&quot;);</span>
        }
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (primaries.contains(column))</span>
<span class="nc" id="L161">            out.write(&quot; &lt;td class='primaryKey' title='Primary Key'&gt;&quot;);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        else if (indexedColumns.contains(column))</span>
<span class="nc" id="L163">            out.write(&quot; &lt;td class='indexedColumn' title='Indexed'&gt;&quot;);</span>
        else
<span class="nc" id="L165">            out.write(&quot; &lt;td class='detail'&gt;&quot;);</span>
<span class="nc" id="L166">        out.write(column.getName());</span>
<span class="nc" id="L167">        out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L168">        out.write(&quot; &lt;td class='detail'&gt;&quot;);</span>
<span class="nc" id="L169">        out.write(column.getType().toLowerCase());</span>
<span class="nc" id="L170">        out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L171">        out.write(&quot; &lt;td class='detail' align='right'&gt;&quot;);</span>
<span class="nc" id="L172">        out.write(column.getDetailedSize());</span>
<span class="nc" id="L173">        out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L174">        out.write(&quot; &lt;td class='detail' align='center'&quot;);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (column.isNullable())</span>
<span class="nc" id="L176">            out.write(&quot; title='nullable'&gt;&amp;nbsp;&amp;radic;&amp;nbsp;&quot;);</span>
        else
<span class="nc" id="L178">            out.write(&quot;&gt;&quot;);</span>
<span class="nc" id="L179">        out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L180">        out.write(&quot; &lt;td class='detail' align='center'&quot;);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (column.isAutoUpdated()) {</span>
<span class="nc" id="L182">            out.write(&quot; title='Automatically updated by the database'&gt;&amp;nbsp;&amp;radic;&amp;nbsp;&quot;);</span>
        } else {
<span class="nc" id="L184">            out.write(&quot;&gt;&quot;);</span>
        }
<span class="nc" id="L186">        out.writeln(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc" id="L188">        Object defaultValue = column.getDefaultValue();</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">        if (defaultValue != null || column.isNullable()) {</span>
<span class="nc" id="L190">            Object alias = defaultValueAliases.get(String.valueOf(defaultValue).trim());</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (alias != null) {</span>
<span class="nc" id="L192">                out.write(&quot; &lt;td class='detail' align='right' title='&quot;);</span>
<span class="nc" id="L193">                out.write(String.valueOf(defaultValue));</span>
<span class="nc" id="L194">                out.write(&quot;'&gt;&lt;i&gt;&quot;);</span>
<span class="nc" id="L195">                out.write(alias.toString());</span>
<span class="nc" id="L196">                out.writeln(&quot;&lt;/i&gt;&lt;/td&gt;&quot;);</span>
            } else {
<span class="nc" id="L198">                out.write(&quot; &lt;td class='detail' align='right'&gt;&quot;);</span>
<span class="nc" id="L199">                out.write(String.valueOf(defaultValue));</span>
<span class="nc" id="L200">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>
            }
<span class="nc" id="L202">        } else {</span>
<span class="nc" id="L203">            out.writeln(&quot; &lt;td class='detail'&gt;&lt;/td&gt;&quot;);</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!slim) {</span>
<span class="nc" id="L206">            out.write(&quot; &lt;td class='detail'&gt;&quot;);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            String path = tableName == null ? &quot;&quot; : &quot;tables/&quot;;</span>
<span class="nc" id="L208">            writeRelatives(column, false, path, even, out);</span>
<span class="nc" id="L209">            out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L210">            out.write(&quot; &lt;td class='detail'&gt;&quot;);</span>
<span class="nc" id="L211">            writeRelatives(column, true, path, even, out);</span>
<span class="nc" id="L212">            out.writeln(&quot; &lt;/td&gt;&quot;);</span>
        }
<span class="nc" id="L214">        out.write(&quot; &lt;td class='comment detail'&gt;&quot;);</span>
<span class="nc" id="L215">        String comments = column.getComments();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (comments != null) {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (encodeComments)</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                for (int i = 0; i &lt; comments.length(); ++i)</span>
<span class="nc" id="L219">                    out.write(HtmlEncoder.encodeToken(comments.charAt(i)));</span>
            else
<span class="nc" id="L221">                out.write(comments);</span>
        }
<span class="nc" id="L223">        out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L224">        out.writeln(&quot;&lt;/tr&gt;&quot;);</span>
<span class="nc" id="L225">    }</span>

    /**
     * Write our relatives
     * @param tableName String
     * @param baseRelative TableColumn
     * @param dumpParents boolean
     * @param out LineWriter
     * @throws IOException
     */
    private void writeRelatives(TableColumn baseRelative, boolean dumpParents, String path, boolean even, LineWriter out) throws IOException {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        Set&lt;TableColumn&gt; columns = dumpParents ? baseRelative.getParents() : baseRelative.getChildren();</span>
<span class="nc" id="L237">        final int numColumns = columns.size();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        final String evenOdd = (even ? &quot;even&quot; : &quot;odd&quot;);</span>

<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (numColumns &gt; 0) {</span>
<span class="nc" id="L241">            out.newLine();</span>
<span class="nc" id="L242">            out.writeln(&quot;  &lt;table border='0' width='100%' cellspacing='0' cellpadding='0'&gt;&quot;);</span>
        }

<span class="nc bnc" id="L245" title="All 2 branches missed.">        for (TableColumn column : columns) {</span>
<span class="nc" id="L246">            Table columnTable = column.getTable();</span>
<span class="nc" id="L247">            String columnTableName = columnTable.getName();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            ForeignKeyConstraint constraint = dumpParents ? column.getChildConstraint(baseRelative) : column.getParentConstraint(baseRelative);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (constraint.isImplied())</span>
<span class="nc" id="L250">                out.writeln(&quot;   &lt;tr class='impliedRelationship relative &quot; + evenOdd + &quot;' valign='top'&gt;&quot;);</span>
            else
<span class="nc" id="L252">                out.writeln(&quot;   &lt;tr class='relative &quot; + evenOdd + &quot;' valign='top'&gt;&quot;);</span>
<span class="nc" id="L253">            out.write(&quot;    &lt;td class='relatedTable detail' title=\&quot;&quot;);</span>
<span class="nc" id="L254">            out.write(constraint.toString());</span>
<span class="nc" id="L255">            out.write(&quot;\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L256" title="All 4 branches missed.">            if (columnTable.isRemote() &amp;&amp; !Config.getInstance().isOneOfMultipleSchemas()) {</span>
<span class="nc" id="L257">                out.write(columnTable.getContainer());</span>
<span class="nc" id="L258">                out.write('.');</span>
<span class="nc" id="L259">                out.write(columnTableName);</span>
            } else {
<span class="nc bnc" id="L261" title="All 2 branches missed.">                if (columnTable.isRemote()) {</span>
<span class="nc" id="L262">                    out.write(&quot;&lt;a href='&quot;);</span>
<span class="nc" id="L263">                    out.write(path);</span>
<span class="nc" id="L264">                    out.write(&quot;../../&quot; + urlEncode(columnTable.getContainer()) + &quot;/index.html'&gt;&quot;);</span>
<span class="nc" id="L265">                    out.write(columnTable.getContainer());</span>
<span class="nc" id="L266">                    out.write(&quot;&lt;/a&gt;.&quot;);</span>
                }
<span class="nc" id="L268">                out.write(&quot;&lt;a href='&quot;);</span>
<span class="nc" id="L269">                out.write(path);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                if (columnTable.isRemote()) {</span>
<span class="nc" id="L271">                    out.write(&quot;../../&quot; + urlEncode(columnTable.getContainer()) + &quot;/tables/&quot;);</span>
                }
<span class="nc" id="L273">                out.write(urlEncode(columnTableName));</span>
<span class="nc" id="L274">                out.write(&quot;.html'&gt;&quot;);</span>
<span class="nc" id="L275">                out.write(columnTableName);</span>
<span class="nc" id="L276">                out.write(&quot;&lt;/a&gt;&quot;);</span>
            }
<span class="nc" id="L278">            out.write(&quot;&lt;span class='relatedKey'&gt;.&quot;);</span>
<span class="nc" id="L279">            out.write(column.getName());</span>
<span class="nc" id="L280">            out.writeln(&quot;&lt;/span&gt;&quot;);</span>
<span class="nc" id="L281">            out.writeln(&quot;    &lt;/td&gt;&quot;);</span>

<span class="nc" id="L283">            out.write(&quot;    &lt;td class='constraint detail'&gt;&quot;);</span>
<span class="nc" id="L284">            out.write(constraint.getName());</span>
<span class="nc" id="L285">            String ruleText = constraint.getDeleteRuleDescription();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (ruleText.length() &gt; 0)</span>
            {
<span class="nc" id="L288">                String ruleAlias = constraint.getDeleteRuleAlias();</span>
<span class="nc" id="L289">                out.write(&quot;&lt;span title='&quot; + ruleText + &quot;'&gt;&amp;nbsp;&quot; + ruleAlias + &quot;&lt;/span&gt;&quot;);</span>
            }
<span class="nc" id="L291">            out.writeln(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc" id="L293">            out.writeln(&quot;   &lt;/tr&gt;&quot;);</span>
<span class="nc" id="L294">        }</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (numColumns &gt; 0) {</span>
<span class="nc" id="L296">            out.writeln(&quot;  &lt;/table&gt;&quot;);</span>
        }
<span class="nc" id="L298">    }</span>

    private void writeNumRows(Database db, Table table, LineWriter out) throws IOException {
<span class="nc" id="L301">        out.write(&quot;&lt;p title='&quot; + table.getColumns().size() + &quot; columns'&gt;&quot;);</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">        if (displayNumRows &amp;&amp; table.getNumRows() &gt;= 0) {</span>
<span class="nc" id="L303">            out.write(&quot;Table contained &quot; + NumberFormat.getIntegerInstance().format(table.getNumRows()) + &quot; rows at &quot;);</span>
        } else {
<span class="nc" id="L305">            out.write(&quot;Analyzed at &quot;);</span>
        }
<span class="nc" id="L307">        out.write(db.getConnectTime());</span>
<span class="nc" id="L308">        out.writeln(&quot;&lt;p/&gt;&quot;);</span>
<span class="nc" id="L309">    }</span>

    private void writeCheckConstraints(Table table, LineWriter out) throws IOException {
<span class="nc" id="L312">        Map&lt;String, String&gt; constraints = table.getCheckConstraints();</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">        if (constraints != null &amp;&amp; !constraints.isEmpty()) {</span>
<span class="nc" id="L314">            out.writeln(&quot;&lt;div class='indent'&gt;&quot;);</span>
<span class="nc" id="L315">            out.writeln(&quot;&lt;b&gt;Requirements (check constraints):&lt;/b&gt;&quot;);</span>
<span class="nc" id="L316">            out.writeln(&quot;&lt;table class='dataTable' border='1' rules='groups'&gt;&lt;colgroup&gt;&lt;colgroup&gt;&quot;);</span>
<span class="nc" id="L317">            out.writeln(&quot;&lt;thead&gt;&quot;);</span>
<span class="nc" id="L318">            out.writeln(&quot; &lt;tr&gt;&quot;);</span>
<span class="nc" id="L319">            out.writeln(&quot;  &lt;th&gt;Constraint&lt;/th&gt;&quot;);</span>
<span class="nc" id="L320">            out.writeln(&quot;  &lt;th class='constraint' style='text-align:left;'&gt;Constraint Name&lt;/th&gt;&quot;);</span>
<span class="nc" id="L321">            out.writeln(&quot; &lt;/tr&gt;&quot;);</span>
<span class="nc" id="L322">            out.writeln(&quot;&lt;/thead&gt;&quot;);</span>
<span class="nc" id="L323">            out.writeln(&quot;&lt;tbody&gt;&quot;);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            for (String name : constraints.keySet()) {</span>
<span class="nc" id="L325">                out.writeln(&quot; &lt;tr&gt;&quot;);</span>
<span class="nc" id="L326">                out.write(&quot;  &lt;td class='detail'&gt;&quot;);</span>
<span class="nc" id="L327">                out.write(HtmlEncoder.encodeString(constraints.get(name).toString()));</span>
<span class="nc" id="L328">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L329">                out.write(&quot;  &lt;td class='constraint' style='text-align:left;'&gt;&quot;);</span>
<span class="nc" id="L330">                out.write(name);</span>
<span class="nc" id="L331">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L332">                out.writeln(&quot; &lt;/tr&gt;&quot;);</span>
<span class="nc" id="L333">            }</span>
<span class="nc" id="L334">            out.writeln(&quot;&lt;/tbody&gt;&quot;);</span>
<span class="nc" id="L335">            out.writeln(&quot;&lt;/table&gt;&lt;/div&gt;&lt;p&gt;&quot;);</span>
        }
<span class="nc" id="L337">    }</span>

    private void writeIndexes(Table table, LineWriter out) throws IOException {
<span class="nc bnc" id="L340" title="All 2 branches missed.">        boolean showId = table.getId() != null;</span>
<span class="nc" id="L341">        Set&lt;TableIndex&gt; indexes = table.getIndexes();</span>
<span class="nc bnc" id="L342" title="All 4 branches missed.">        if (indexes != null &amp;&amp; !indexes.isEmpty()) {</span>
            // see if we've got any strangeness so we can have the correct number of colgroups
<span class="nc" id="L344">            boolean containsAnomalies = false;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            for (TableIndex index : indexes) {</span>
<span class="nc" id="L346">                containsAnomalies = index.isUniqueNullable();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if (containsAnomalies)</span>
<span class="nc" id="L348">                    break;</span>
<span class="nc" id="L349">            }</span>

<span class="nc" id="L351">            out.writeln(&quot;&lt;div class='indent'&gt;&quot;);</span>
<span class="nc" id="L352">            out.writeln(&quot;&lt;b&gt;Indexes:&lt;/b&gt;&quot;);</span>
<span class="nc bnc" id="L353" title="All 4 branches missed.">            out.writeln(&quot;&lt;table class='dataTable' border='1' rules='groups'&gt;&lt;colgroup&gt;&lt;colgroup&gt;&lt;colgroup&gt;&lt;colgroup&gt;&quot; + (showId ? &quot;&lt;colgroup&gt;&quot; : &quot;&quot;) + (containsAnomalies ? &quot;&lt;colgroup&gt;&quot; : &quot;&quot;));</span>
<span class="nc" id="L354">            out.writeln(&quot;&lt;thead&gt;&quot;);</span>
<span class="nc" id="L355">            out.writeln(&quot; &lt;tr&gt;&quot;);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (showId)</span>
<span class="nc" id="L357">                out.writeln(&quot;  &lt;th&gt;ID&lt;/th&gt;&quot;);</span>
<span class="nc" id="L358">            out.writeln(&quot;  &lt;th&gt;Column(s)&lt;/th&gt;&quot;);</span>
<span class="nc" id="L359">            out.writeln(&quot;  &lt;th&gt;Type&lt;/th&gt;&quot;);</span>
<span class="nc" id="L360">            out.writeln(&quot;  &lt;th&gt;Sort&lt;/th&gt;&quot;);</span>
<span class="nc" id="L361">            out.writeln(&quot;  &lt;th class='constraint' style='text-align:left;'&gt;Constraint Name&lt;/th&gt;&quot;);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (containsAnomalies)</span>
<span class="nc" id="L363">                out.writeln(&quot;  &lt;th&gt;Anomalies&lt;/th&gt;&quot;);</span>
<span class="nc" id="L364">            out.writeln(&quot; &lt;/tr&gt;&quot;);</span>
<span class="nc" id="L365">            out.writeln(&quot;&lt;/thead&gt;&quot;);</span>
<span class="nc" id="L366">            out.writeln(&quot;&lt;tbody&gt;&quot;);</span>

<span class="nc" id="L368">            indexes = new TreeSet&lt;TableIndex&gt;(indexes); // sort primary keys first</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">            for (TableIndex index : indexes) {</span>
<span class="nc" id="L371">                out.writeln(&quot; &lt;tr&gt;&quot;);</span>

<span class="nc bnc" id="L373" title="All 2 branches missed.">                if (showId) {</span>
<span class="nc" id="L374">                    out.write(&quot;  &lt;td class='detail' align='right'&gt;&quot;);</span>
<span class="nc" id="L375">                    out.write(String.valueOf(index.getId()));</span>
<span class="nc" id="L376">                    out.writeln(&quot;&lt;/td&gt;&quot;);</span>
                }

<span class="nc bnc" id="L379" title="All 2 branches missed.">                if (index.isPrimaryKey())</span>
<span class="nc" id="L380">                    out.write(&quot;  &lt;td class='primaryKey'&gt;&quot;);</span>
                else
<span class="nc" id="L382">                    out.write(&quot;  &lt;td class='indexedColumn'&gt;&quot;);</span>
<span class="nc" id="L383">                String columns = index.getColumnsAsString();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                if (columns.startsWith(&quot;+&quot;))</span>
<span class="nc" id="L385">                    columns = columns.substring(1);</span>
<span class="nc" id="L386">                out.write(columns);</span>
<span class="nc" id="L387">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc" id="L389">                out.write(&quot;  &lt;td class='detail'&gt;&quot;);</span>
<span class="nc" id="L390">                out.write(index.getType());</span>
<span class="nc" id="L391">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc" id="L393">                out.write(&quot;  &lt;td class='detail' style='text-align:left;'&gt;&quot;);</span>
<span class="nc" id="L394">                Iterator&lt;TableColumn&gt; columnsIter = index.getColumns().iterator();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                while (columnsIter.hasNext()) {</span>
<span class="nc" id="L396">                    TableColumn column = columnsIter.next();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                    if (index.isAscending(column))</span>
<span class="nc" id="L398">                        out.write(&quot;&lt;span title='Ascending'&gt;Asc&lt;/span&gt;&quot;);</span>
                    else
<span class="nc" id="L400">                        out.write(&quot;&lt;span title='Descending'&gt;Desc&lt;/span&gt;&quot;);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                    if (columnsIter.hasNext())</span>
<span class="nc" id="L402">                        out.write(&quot;/&quot;);</span>
<span class="nc" id="L403">                }</span>
<span class="nc" id="L404">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc" id="L406">                out.write(&quot;  &lt;td class='constraint' style='text-align:left;'&gt;&quot;);</span>
<span class="nc" id="L407">                out.write(index.getName());</span>
<span class="nc" id="L408">                out.writeln(&quot;&lt;/td&gt;&quot;);</span>

<span class="nc bnc" id="L410" title="All 2 branches missed.">                if (index.isUniqueNullable()) {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">                    if (index.getColumns().size() == 1)</span>
<span class="nc" id="L412">                        out.writeln(&quot;  &lt;td class='detail'&gt;This unique column is also nullable&lt;/td&gt;&quot;);</span>
                    else
<span class="nc" id="L414">                        out.writeln(&quot;  &lt;td class='detail'&gt;These unique columns are also nullable&lt;/td&gt;&quot;);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                } else if (containsAnomalies) {</span>
<span class="nc" id="L416">                    out.writeln(&quot;  &lt;td&gt;&amp;nbsp;&lt;/td&gt;&quot;);</span>
                }
<span class="nc" id="L418">                out.writeln(&quot; &lt;/tr&gt;&quot;);</span>
<span class="nc" id="L419">            }</span>
<span class="nc" id="L420">            out.writeln(&quot;&lt;/tbody&gt;&quot;);</span>
<span class="nc" id="L421">            out.writeln(&quot;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L422">            out.writeln(&quot;&lt;/div&gt;&quot;);</span>
        }
<span class="nc" id="L424">    }</span>

    private void writeView(Table table, Database db, LineWriter out) throws IOException {
        String sql;
<span class="nc bnc" id="L428" title="All 4 branches missed.">        if (table.isView() &amp;&amp; (sql = table.getViewSql()) != null) {</span>
<span class="nc" id="L429">            Map&lt;String, Table&gt; tables = new CaseInsensitiveMap&lt;Table&gt;();</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">            for (Table t : db.getTables())</span>
<span class="nc" id="L432">                tables.put(t.getName(), t);</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            for (View v : db.getViews())</span>
<span class="nc" id="L434">                tables.put(v.getName(), v);</span>

<span class="nc" id="L436">            Set&lt;Table&gt; references = new TreeSet&lt;Table&gt;();</span>
<span class="nc" id="L437">            String formatted = Config.getInstance().getSqlFormatter().format(sql, db, references);</span>

<span class="nc" id="L439">            out.writeln(&quot;&lt;div class='indent spacer'&gt;&quot;);</span>
<span class="nc" id="L440">            out.writeln(&quot;  View Definition:&quot;);</span>
<span class="nc" id="L441">            out.writeln(formatted);</span>
<span class="nc" id="L442">            out.writeln(&quot;&lt;/div&gt;&quot;);</span>
<span class="nc" id="L443">            out.writeln(&quot;&lt;div class='spacer'&gt;&amp;nbsp;&lt;/div&gt;&quot;);</span>

<span class="nc bnc" id="L445" title="All 2 branches missed.">            if (!references.isEmpty()) {</span>
<span class="nc" id="L446">                out.writeln(&quot;&lt;div class='indent'&gt;&quot;);</span>
<span class="nc" id="L447">                out.writeln(&quot;  Possibly Referenced Tables/Views:&quot;);</span>
<span class="nc" id="L448">                out.writeln(&quot;  &lt;div class='viewReferences'&gt;&quot;);</span>
<span class="nc" id="L449">                out.write(&quot;  &quot;);</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                for (Table t : references) {</span>
<span class="nc" id="L451">                    out.write(&quot;&lt;a href='&quot;);</span>
<span class="nc" id="L452">                    out.write(urlEncode(t.getName()));</span>
<span class="nc" id="L453">                    out.write(&quot;.html'&gt;&quot;);</span>
<span class="nc" id="L454">                    out.write(t.getName());</span>
<span class="nc" id="L455">                    out.write(&quot;&lt;/a&gt;&amp;nbsp;&quot;);</span>
<span class="nc" id="L456">                }</span>

<span class="nc" id="L458">                out.writeln(&quot;  &lt;/div&gt;&quot;);</span>
<span class="nc" id="L459">                out.writeln(&quot;&lt;/div&gt;&lt;p/&gt;&quot;);</span>
            }

        }
<span class="nc" id="L463">    }</span>

    /**
     * Generate the .dot file(s) to represent the specified table's relationships.
     *
     * Generates a &lt;TABLENAME&gt;.dot if the table has real relatives.
     *
     * Also generates a &lt;TABLENAME&gt;.implied2degrees.dot if the table has implied relatives within
     * two degrees of separation.
     *
     * @param table Table
     * @param diagramsDir File
     * @throws IOException
     * @return boolean &lt;code&gt;true&lt;/code&gt; if the table has implied relatives within two
     *                 degrees of separation.
     */
    private boolean generateDots(Table table, File diagramDir, WriteStats stats) throws IOException {
<span class="fc" id="L480">        Dot dot = Dot.getInstance();</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">        String extension = dot == null ? &quot;png&quot; : dot.getFormat();</span>

<span class="nc" id="L483">        File oneDegreeDotFile = new File(diagramDir, table.getName() + &quot;.1degree.dot&quot;);</span>
<span class="nc" id="L484">        File oneDegreeDiagramFile = new File(diagramDir, table.getName() + &quot;.1degree.&quot; + extension);</span>
<span class="nc" id="L485">        File twoDegreesDotFile = new File(diagramDir, table.getName() + &quot;.2degrees.dot&quot;);</span>
<span class="nc" id="L486">        File twoDegreesDiagramFile = new File(diagramDir, table.getName() + &quot;.2degrees.&quot; + extension);</span>
<span class="nc" id="L487">        File impliedDotFile = new File(diagramDir, table.getName() + &quot;.implied2degrees.dot&quot;);</span>
<span class="nc" id="L488">        File impliedDiagramFile = new File(diagramDir, table.getName() + &quot;.implied2degrees.&quot; + extension);</span>

        // delete before we start because we'll use the existence of these files to determine
        // if they should be turned into pngs &amp; presented
<span class="nc" id="L492">        oneDegreeDotFile.delete();</span>
<span class="nc" id="L493">        oneDegreeDiagramFile.delete();</span>
<span class="nc" id="L494">        twoDegreesDotFile.delete();</span>
<span class="nc" id="L495">        twoDegreesDiagramFile.delete();</span>
<span class="nc" id="L496">        impliedDotFile.delete();</span>
<span class="nc" id="L497">        impliedDiagramFile.delete();</span>

<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (table.getMaxChildren() + table.getMaxParents() &gt; 0) {</span>
            Set&lt;ForeignKeyConstraint&gt; impliedConstraints;

<span class="nc" id="L502">            DotFormatter formatter = DotFormatter.getInstance();</span>
<span class="nc" id="L503">            LineWriter dotOut = new LineWriter(oneDegreeDotFile, Config.DOT_CHARSET);</span>
<span class="nc" id="L504">            WriteStats oneStats = new WriteStats(stats);</span>
<span class="nc" id="L505">            formatter.writeRealRelationships(table, false, oneStats, dotOut);</span>
<span class="nc" id="L506">            dotOut.close();</span>

<span class="nc" id="L508">            dotOut = new LineWriter(twoDegreesDotFile, Config.DOT_CHARSET);</span>
<span class="nc" id="L509">            WriteStats twoStats = new WriteStats(stats);</span>
<span class="nc" id="L510">            impliedConstraints = formatter.writeRealRelationships(table, true, twoStats, dotOut);</span>
<span class="nc" id="L511">            dotOut.close();</span>

<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (oneStats.getNumTablesWritten() + oneStats.getNumViewsWritten() == twoStats.getNumTablesWritten() + twoStats.getNumViewsWritten()) {</span>
<span class="nc" id="L514">                twoDegreesDotFile.delete(); // no different than before, so don't show it</span>
            }

<span class="nc bnc" id="L517" title="All 2 branches missed.">            if (!impliedConstraints.isEmpty()) {</span>
<span class="nc" id="L518">                dotOut = new LineWriter(impliedDotFile, Config.DOT_CHARSET);</span>
<span class="nc" id="L519">                formatter.writeAllRelationships(table, true, stats, dotOut);</span>
<span class="nc" id="L520">                dotOut.close();</span>
<span class="nc" id="L521">                return true;</span>
            }
        }

<span class="nc" id="L525">        return false;</span>
    }

    private void writeDiagram(Table table, WriteStats stats, File diagramsDir, LineWriter html) throws IOException {
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (table.getMaxChildren() + table.getMaxParents() &gt; 0) {</span>
<span class="nc" id="L530">            html.writeln(&quot;&lt;table width='100%' border='0'&gt;&lt;tr&gt;&lt;td class='container'&gt;&quot;);</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">            if (HtmlTableDiagrammer.getInstance().write(table, diagramsDir, html)) {</span>
<span class="nc" id="L532">                html.writeln(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<span class="nc" id="L533">                writeExcludedColumns(stats.getExcludedColumns(), table, html);</span>
            } else {
<span class="nc" id="L535">                html.writeln(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p&gt;&quot;);</span>
<span class="nc" id="L536">                writeInvalidGraphvizInstallation(html);</span>
            }
        }
<span class="nc" id="L539">    }</span>

    @Override
    protected String getPathToRoot() {
<span class="fc" id="L543">        return &quot;../&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201405220205</span></div></body></html>